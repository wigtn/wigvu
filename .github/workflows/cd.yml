name: CD - Build & Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated: web,api,ai,nginx,infra or all)'
        required: false
        default: 'all'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_ZONE: ${{ secrets.GCP_ZONE }}
  GCE_INSTANCE: ${{ secrets.GCE_INSTANCE }}

jobs:
  # 변경된 파일 감지
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      web: ${{ steps.changes.outputs.web }}
      api: ${{ steps.changes.outputs.api }}
      ai: ${{ steps.changes.outputs.ai }}
      nginx: ${{ steps.changes.outputs.nginx }}
      infra: ${{ steps.changes.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          # Manual trigger with specific services
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SERVICES="${{ github.event.inputs.services }}"
            if [ "$SERVICES" == "all" ]; then
              echo "web=true" >> $GITHUB_OUTPUT
              echo "api=true" >> $GITHUB_OUTPUT
              echo "ai=true" >> $GITHUB_OUTPUT
              echo "nginx=true" >> $GITHUB_OUTPUT
              echo "infra=true" >> $GITHUB_OUTPUT
            else
              echo "web=$([[ $SERVICES == *web* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "api=$([[ $SERVICES == *api* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "ai=$([[ $SERVICES == *ai* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "nginx=$([[ $SERVICES == *nginx* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
              echo "infra=$([[ $SERVICES == *infra* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            fi
          else
            # Auto detect changes on push
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "Changed files: $CHANGED_FILES"

            echo "web=$([[ $CHANGED_FILES == *apps/web/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "api=$([[ $CHANGED_FILES == *apps/api/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "ai=$([[ $CHANGED_FILES == *apps/ai/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "nginx=$([[ $CHANGED_FILES == *nginx/* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
            echo "infra=$([[ $CHANGED_FILES == *docker-compose* ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          fi

  # Web 이미지 빌드 & GHCR 푸시
  build-web:
    name: Build & Push Web
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Web image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/web
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/wigvu-web:latest
            ${{ env.IMAGE_PREFIX }}/wigvu-web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # API 이미지 빌드 & GHCR 푸시
  build-api:
    name: Build & Push API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/wigvu-api:latest
            ${{ env.IMAGE_PREFIX }}/wigvu-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # AI 이미지 빌드 & GHCR 푸시
  build-ai:
    name: Build & Push AI
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ai == 'true'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push AI image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/ai
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/wigvu-ai:latest
            ${{ env.IMAGE_PREFIX }}/wigvu-ai:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # GCE 배포
  deploy:
    name: Deploy to GCE
    runs-on: ubuntu-latest
    needs: [detect-changes, build-web, build-api, build-ai]
    # 빌드 job 중 하나라도 성공하거나 스킵된 경우, 또는 nginx/infra 변경 시 실행
    if: |
      always() &&
      (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
      (needs.build-api.result == 'success' || needs.build-api.result == 'skipped') &&
      (needs.build-ai.result == 'success' || needs.build-ai.result == 'skipped') &&
      (needs.build-web.result == 'success' || needs.build-api.result == 'success' || needs.build-ai.result == 'success' || needs.detect-changes.outputs.nginx == 'true' || needs.detect-changes.outputs.infra == 'true')
    environment: production

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to GCE
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              echo '${{ secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin && \
              git config --global --add safe.directory /opt/wigvu && \
              cd /opt/wigvu && \
              git pull origin main && \
              docker compose -f docker-compose.hub.yml pull && \
              # 인증서 디렉토리 생성
              mkdir -p certbot/conf/live/app.wigtn.com && \
              mkdir -p certbot/www && \
              # 기존 인증서가 wigtn.com 경로에 있으면 app.wigtn.com으로 복사 또는 심볼릭 링크
              if [ -f certbot/conf/live/wigtn.com/fullchain.pem ] && [ ! -f certbot/conf/live/app.wigtn.com/fullchain.pem ]; then
                echo '기존 인증서(wigtn.com)를 app.wigtn.com 경로로 복사합니다...' && \
                cp -r certbot/conf/live/wigtn.com/* certbot/conf/live/app.wigtn.com/ 2>/dev/null || \
                (mkdir -p certbot/conf/live/app.wigtn.com && \
                 cp certbot/conf/live/wigtn.com/fullchain.pem certbot/conf/live/app.wigtn.com/fullchain.pem && \
                 cp certbot/conf/live/wigtn.com/privkey.pem certbot/conf/live/app.wigtn.com/privkey.pem) && \
                echo '인증서 복사 완료'
              fi && \
              # 인증서가 없으면 임시 더미 인증서 생성 (nginx 시작을 위해)
              if [ ! -f certbot/conf/live/app.wigtn.com/fullchain.pem ]; then
                echo '임시 더미 인증서를 생성합니다...' && \
                mkdir -p certbot/conf/live/app.wigtn.com && \
                openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
                  -keyout certbot/conf/live/app.wigtn.com/privkey.pem \
                  -out certbot/conf/live/app.wigtn.com/fullchain.pem \
                  -subj '/CN=app.wigtn.com' 2>/dev/null || echo '더미 인증서 생성 실패 (계속 진행)'
              fi && \
              # nginx를 제외한 서비스들 먼저 시작
              docker compose -f docker-compose.hub.yml up -d web api ai && \
              # nginx 시작 (더미 인증서로 시작)
              docker compose -f docker-compose.hub.yml up -d nginx || true && \
              docker system prune -f
            "

      - name: Setup SSL certificate (initial)
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              cd /opt/wigvu && \
              # 기존 인증서가 wigtn.com 경로에 있으면 app.wigtn.com으로 복사
              if [ -f certbot/conf/live/wigtn.com/fullchain.pem ] && [ ! -f certbot/conf/live/app.wigtn.com/fullchain.pem ]; then
                echo '기존 인증서(wigtn.com)를 app.wigtn.com 경로로 복사합니다...' && \
                mkdir -p certbot/conf/live/app.wigtn.com && \
                cp certbot/conf/live/wigtn.com/fullchain.pem certbot/conf/live/app.wigtn.com/fullchain.pem && \
                cp certbot/conf/live/wigtn.com/privkey.pem certbot/conf/live/app.wigtn.com/privkey.pem && \
                echo '인증서 복사 완료. nginx를 재시작합니다...' && \
                docker compose -f docker-compose.hub.yml restart nginx
              fi && \
              # 인증서가 이미 유효한지 확인 (더미 인증서가 아닌 실제 인증서)
              if [ ! -f certbot/conf/live/app.wigtn.com/fullchain.pem ] || \
                 [ \$(find certbot/conf/live/app.wigtn.com/fullchain.pem -mtime +1 2>/dev/null | wc -l) -gt 0 ] || \
                 [ \$(stat -c%s certbot/conf/live/app.wigtn.com/fullchain.pem 2>/dev/null) -lt 1000 ]; then
                echo 'SSL 인증서가 없거나 유효하지 않습니다. 초기 인증서를 발급합니다...' && \
                # nginx가 실행 중이어야 webroot 방식이 작동함
                sleep 5 && \
                docker compose -f docker-compose.hub.yml run --rm certbot certonly \
                  --webroot \
                  --webroot-path=/var/www/certbot \
                  --email admin@wigtn.com \
                  --agree-tos \
                  --no-eff-email \
                  --non-interactive \
                  -d app.wigtn.com \
                  -d www.app.wigtn.com && \
                echo 'SSL 인증서 발급 완료. nginx를 재시작합니다...' && \
                docker compose -f docker-compose.hub.yml restart nginx
              else
                echo 'SSL 인증서가 이미 존재하고 유효합니다.'
              fi
            "

      - name: Reload nginx gracefully (if config changed)
        if: needs.detect-changes.outputs.nginx == 'true'
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              cd /opt/wigvu && \
              # 인증서가 있는 경우에만 nginx 설정 테스트 및 리로드
              if [ -f certbot/conf/live/app.wigtn.com/fullchain.pem ]; then
                docker compose -f docker-compose.hub.yml exec -T nginx nginx -t && \
                docker compose -f docker-compose.hub.yml exec -T nginx nginx -s reload
              else
                echo '인증서가 아직 없어서 nginx 리로드를 건너뜁니다.'
              fi
            "

      - name: Setup SSL auto-renewal cron (one-time)
        run: |
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              # SSL 인증서 자동 갱신 cron job 설정 (이미 있으면 스킵)
              CRON_CMD='0 3 * * * cd /opt/wigvu && docker compose -f docker-compose.hub.yml run --rm certbot renew --quiet && docker compose -f docker-compose.hub.yml exec -T nginx nginx -s reload'
              (crontab -l 2>/dev/null | grep -q 'certbot renew') || (crontab -l 2>/dev/null; echo \"\$CRON_CMD\") | crontab -
            "

      - name: Health check
        run: |
          sleep 30
          gcloud compute ssh ${{ env.GCE_INSTANCE }} \
            --zone=${{ env.GCP_ZONE }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --command="
              curl -f http://localhost:4000/api/v1/health || exit 1
              curl -f http://localhost:3000 || exit 1
            "

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Web | ${{ needs.detect-changes.outputs.web }} | ${{ needs.build-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.detect-changes.outputs.api }} | ${{ needs.build-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI | ${{ needs.detect-changes.outputs.ai }} | ${{ needs.build-ai.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx | ${{ needs.detect-changes.outputs.nginx }} | config-only |" >> $GITHUB_STEP_SUMMARY
          echo "| Infra | ${{ needs.detect-changes.outputs.infra }} | config-only |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "### ✅ Deployment successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Deployment failed!" >> $GITHUB_STEP_SUMMARY
          fi
